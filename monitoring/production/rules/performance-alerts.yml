groups:
  - name: performance.rules
    rules:
      # Database Performance
      - alert: DatabaseSlowQueries
        expr: rate(pg_stat_database_tup_returned[5m]) / rate(pg_stat_database_tup_fetched[5m]) < 0.1
        for: 5m
        labels:
          severity: warning
          category: performance
          component: database
        annotations:
          summary: "Database has many slow queries"
          description: "Database query efficiency is below 10% for more than 5 minutes"
          runbook_url: "https://runbooks.yourplatform.com/performance/slow-queries"

      - alert: DatabaseHighConnections
        expr: pg_stat_database_numbackends > 80
        for: 5m
        labels:
          severity: warning
          category: performance
          component: database
        annotations:
          summary: "High number of database connections"
          description: "Database has more than 80 active connections for more than 5 minutes"
          runbook_url: "https://runbooks.yourplatform.com/performance/high-db-connections"

      - alert: DatabaseLockWaits
        expr: rate(pg_stat_database_conflicts[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
          category: performance
          component: database
        annotations:
          summary: "Database lock waits detected"
          description: "Database is experiencing lock waits for more than 2 minutes"
          runbook_url: "https://runbooks.yourplatform.com/performance/db-locks"

      # Cache Performance
      - alert: RedisCacheHitRateLow
        expr: redis_keyspace_hits / (redis_keyspace_hits + redis_keyspace_misses) * 100 < 80
        for: 10m
        labels:
          severity: warning
          category: performance
          component: cache
        annotations:
          summary: "Redis cache hit rate is low"
          description: "Redis cache hit rate has been below 80% for more than 10 minutes"
          runbook_url: "https://runbooks.yourplatform.com/performance/cache-hit-rate"

      - alert: RedisSlowQueries
        expr: redis_slowlog_length > 10
        for: 5m
        labels:
          severity: warning
          category: performance
          component: cache
        annotations:
          summary: "Redis has slow queries"
          description: "Redis slow log has more than 10 entries for more than 5 minutes"
          runbook_url: "https://runbooks.yourplatform.com/performance/redis-slow-queries"

      # API Performance
      - alert: APIHighLatencyP99
        expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m])) > 3
        for: 5m
        labels:
          severity: warning
          category: performance
          component: api
        annotations:
          summary: "API 99th percentile latency is high"
          description: "99th percentile API latency is above 3 seconds for more than 5 minutes"
          runbook_url: "https://runbooks.yourplatform.com/performance/api-latency-p99"

      - alert: APIThroughputDrop
        expr: (rate(http_requests_total[5m]) - rate(http_requests_total[5m] offset 1h)) / rate(http_requests_total[5m] offset 1h) * 100 < -30
        for: 10m
        labels:
          severity: warning
          category: performance
          component: api
        annotations:
          summary: "API throughput has dropped significantly"
          description: "API throughput has dropped by more than 30% compared to 1 hour ago"
          runbook_url: "https://runbooks.yourplatform.com/performance/throughput-drop"

      # Message Queue Performance
      - alert: RabbitMQHighMessageLatency
        expr: rabbitmq_queue_message_stats_deliver_get_details_avg > 1000
        for: 5m
        labels:
          severity: warning
          category: performance
          component: messaging
        annotations:
          summary: "RabbitMQ message processing latency is high"
          description: "Average message processing time is above 1 second for more than 5 minutes"
          runbook_url: "https://runbooks.yourplatform.com/performance/message-latency"

      - alert: RabbitMQConsumerLag
        expr: rabbitmq_queue_messages - rabbitmq_queue_consumers > 500
        for: 5m
        labels:
          severity: warning
          category: performance
          component: messaging
        annotations:
          summary: "RabbitMQ consumer lag is high"
          description: "Message queue has more than 500 unprocessed messages per consumer for more than 5 minutes"
          runbook_url: "https://runbooks.yourplatform.com/performance/consumer-lag"

      # Search Performance
      - alert: ElasticsearchSlowQueries
        expr: elasticsearch_indices_search_query_time_seconds / elasticsearch_indices_search_query_total > 0.5
        for: 5m
        labels:
          severity: warning
          category: performance
          component: search
        annotations:
          summary: "Elasticsearch has slow search queries"
          description: "Average search query time is above 0.5 seconds for more than 5 minutes"
          runbook_url: "https://runbooks.yourplatform.com/performance/es-slow-queries"

      - alert: ElasticsearchIndexingLag
        expr: elasticsearch_indices_indexing_index_current > 100
        for: 10m
        labels:
          severity: warning
          category: performance
          component: search
        annotations:
          summary: "Elasticsearch indexing lag is high"
          description: "More than 100 documents are currently being indexed for more than 10 minutes"
          runbook_url: "https://runbooks.yourplatform.com/performance/es-indexing-lag"

      # File Storage Performance
      - alert: FileUploadHighLatency
        expr: histogram_quantile(0.95, rate(file_upload_duration_seconds_bucket[5m])) > 10
        for: 5m
        labels:
          severity: warning
          category: performance
          component: storage
        annotations:
          summary: "File upload latency is high"
          description: "95th percentile file upload time is above 10 seconds for more than 5 minutes"
          runbook_url: "https://runbooks.yourplatform.com/performance/file-upload-latency"

      # CDN Performance
      - alert: CDNHighCacheMissRate
        expr: cdn_cache_misses / (cdn_cache_hits + cdn_cache_misses) * 100 > 30
        for: 15m
        labels:
          severity: warning
          category: performance
          component: cdn
        annotations:
          summary: "CDN cache miss rate is high"
          description: "CDN cache miss rate has been above 30% for more than 15 minutes"
          runbook_url: "https://runbooks.yourplatform.com/performance/cdn-cache-miss"

      # Application Performance
      - alert: HighGarbageCollectionTime
        expr: rate(process_gc_duration_seconds[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          category: performance
          component: application
        annotations:
          summary: "High garbage collection time in {{ $labels.job }}"
          description: "Garbage collection is taking more than 10% of CPU time for more than 5 minutes"
          runbook_url: "https://runbooks.yourplatform.com/performance/gc-time"

      - alert: HighThreadPoolUtilization
        expr: thread_pool_active_threads / thread_pool_max_threads * 100 > 80
        for: 5m
        labels:
          severity: warning
          category: performance
          component: application
        annotations:
          summary: "High thread pool utilization in {{ $labels.job }}"
          description: "Thread pool utilization is above 80% for more than 5 minutes"
          runbook_url: "https://runbooks.yourplatform.com/performance/thread-pool"

      # Network Performance
      - alert: HighNetworkLatency
        expr: histogram_quantile(0.95, rate(network_latency_seconds_bucket[5m])) > 0.1
        for: 5m
        labels:
          severity: warning
          category: performance
          component: network
        annotations:
          summary: "High network latency detected"
          description: "95th percentile network latency is above 100ms for more than 5 minutes"
          runbook_url: "https://runbooks.yourplatform.com/performance/network-latency"

      - alert: HighPacketLoss
        expr: rate(network_packets_dropped_total[5m]) / rate(network_packets_total[5m]) * 100 > 1
        for: 5m
        labels:
          severity: warning
          category: performance
          component: network
        annotations:
          summary: "High network packet loss detected"
          description: "Network packet loss is above 1% for more than 5 minutes"
          runbook_url: "https://runbooks.yourplatform.com/performance/packet-loss"